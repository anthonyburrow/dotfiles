#!/usr/bin/env bash
set -euo pipefail

HOST="desktop"
HOST_DIR="~/.secret"
LOCAL_DIR="$HOME/.secret"
LINK_SCRIPT="$LOCAL_DIR/link_secrets"

usage() {
  echo "Usage: $0 {pull|push|dryrun}"
  exit 1
}

if [ $# -eq 0 ]; then usage; fi
ACTION="$1"

log() { echo -e "[*] $1"; }

SOURCE="$HOST:$HOST_DIR"
DEST="$HOST:$HOST_DIR"

case "$ACTION" in
  pull)
    log "Pulling secrets..."
    rsync -avzu "$SOURCE/" "$LOCAL_DIR/"
    if [ -f "$LINK_SCRIPT" ]; then
      log "Re-linking secrets..."
      bash "$LINK_SCRIPT"
    fi
    ;;
  push)
    log "Pushing secrets..."
    rsync -avzu "$LOCAL_DIR/" "$DEST/"
    log "Executing host linking script..."
    ssh "$HOST" '[[ -f "$HOME/.secret/link_secrets" ]] && bash "$HOME/.secret/link_secrets"'
    ;;
  dryrun)
    log "Dry run (pull)..."
    rsync -avzu --dry-run "$SOURCE/" "$LOCAL_DIR/"
    log "Dry run (push)..."
    rsync -avzu --dry-run "$LOCAL_DIR/" "$DEST/"
    ;;
  *)
    usage
    ;;
esac

log "Done."
