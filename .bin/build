#!/bin/bash

source ~/.bashrc

extension="${1##*.}"

case "$extension" in
    py)
        file_path="$1"
        file_dir=$(dirname "$(realpath "$file_path")")

        venv_dir=""
        current_dir="$file_dir"

        while [[ "$current_dir" != "/" ]]; do
            if [[ -d "$current_dir/.venv" ]]; then
                venv_dir="$current_dir/.venv"
                break
            fi
            current_dir=$(dirname "$current_dir")
        done

        fallback_venv="$HOME/.default_python/.venv"

        if [[ -d "$venv_dir" ]]; then
            python_bin="$venv_dir/bin/python"
        elif [[ -d "$fallback_venv" ]]; then
            python_bin="$fallback_venv/bin/python"
        else
            echo "Error: no .venv found and no fallback venv at $fallback_venv" >&2
            exit 1
        fi

        echo "Python: $python_bin"
        cd "$file_dir"
        "$python_bin" "$file_path"
        ;;
    tex)
        cd "$(dirname "$1")"
        latexmk -pdf -interaction=nonstopmode -f "$(basename "$1")"
        latexmk -c "$(basename "$1")"
        ;;
    *)
        echo "No build command defined for .$extension files"
        exit 1
        ;;
esac