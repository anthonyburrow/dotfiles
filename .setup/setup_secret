#!/usr/bin/env bash
set -euo pipefail

HOST="desktop"
HOST_DIR="~/.secret"
LOCAL_DIR="$HOME/.secret"
LINK_SCRIPT="$LOCAL_DIR/link_secrets"

log() { echo -e "[*] $1"; }

SOURCE="$HOST:$HOST_DIR"

mkdir -p "$LOCAL_DIR"

log "Pulling secrets from $SOURCE..."
rsync -avz --ignore-times "$SOURCE/" "$LOCAL_DIR/"

log "Setting safe permissions..."
chmod 700 "$LOCAL_DIR"
chmod -R go-rwx "$LOCAL_DIR"

if [ -f "$LINK_SCRIPT" ]; then
  log "Setting up symlinks..."
  bash "$LINK_SCRIPT"
else
  log "No $LINK_SCRIPT script found"
fi

log "Done."
